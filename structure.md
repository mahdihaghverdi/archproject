# Project Structure

- **`MySimple_project/`**
  - `src/`        for all sources files (.vhd,.ucf,.xcf)
  - `testbench/`  VHDL sources files for testing your design
  - `ise/`        Xilinx web pack will work in this directory
  - `simu/`       All files generated by the simulator


# Simulation
To stay in the Free Software spirit, the best method to simulate is to use [GHDL](http://ghdl.free.fr/) (based on GCC).

```bash
sudo apt install ghdl
```

You can find a good tutorial for using GHDL [here](http://forum.ubuntu-fr.org/viewtopic.php?pid=1545563#p839075) and on [the official website](http://ghdl.free.fr/ghdl/Starting-with-GHDL.html#Starting-with-GHDL). It's supposed that the project tree used is this one described previously.

Analysing files:
```bash
ghdl -i --ieee=synopsys --warn-no-vital-generic --workdir=simu --work=work src/*.vhdl testbench/testb_file.vhd
```

And compile:
```bash
ghdl -m --ieee=synopsys --warn-no-vital-generic --workdir=simu --work=work testb_file
```

After that a binary file named testb_file is created; to launch simulation we just have to:
```bash
./testb_file --stop-time=500ns --vcdgz=testb_file.vcdgz
```

The stop time option sets the simulation time and the vcdgz option will generate a gunzip compressed wave file to visualize the result.

Visualizing the result can be done with gtkwave:
```bash
sudo apt install gtkwave
```

We can launch it with the following command :
```bash
gunzip --stdout testb_file.vcdgz | gtkwave --vcd
```

It can be a good idea to make a Makefile instead of typing all this commands, here is a little Makefile:

```make
# project name
PROJECT=bus_led_top
# vhdl files
FILES = src/bus_led.vhd src/bus_led_top.vhd
# testbench
SIMTOP = led_top_tb
SIMFILES = testbench/led_top_tb.vhd
# Simu break condition
GHDL_SIM_OPT    = --assert-level=error
#GHDL_SIM_OPT    = --stop-time=500ns

SIMDIR = simu
SYNTHFILES = bin/bus_led_ise/netgen/synthesis

GHDL_CMD        = ghdl
GHDL_FLAGS      = --ieee=synopsys --warn-no-vital-generic

VIEW_CMD        = /usr/bin/gtkwave

ghdl-compile :
 mkdir -p simu
 $(GHDL_CMD) -i $(GHDL_FLAGS) --workdir=simu --work=work $(SIMFILES) $(FILES)
 $(GHDL_CMD) -m $(GHDL_FLAGS) --workdir=simu --work=work $(SIMTOP)
 @mv $(SIMTOP) simu/$(SIMTOP)

ghdl-run :
 @$(SIMDIR)/$(SIMTOP) $(GHDL_SIM_OPT) --vcdgz=$(SIMDIR)/$(SIMTOP).vcdgz

ghdl-view:
 gunzip --stdout $(SIMDIR)/$(SIMTOP).vcdgz | $(VIEW_CMD) --vcd

ghdl-clean :
 $(GHDL_CMD) --clean --workdir=simu
```

to use it, just write :
```bash
make ghdl-compile
```

to compile, then:
```bash
make ghdl-run
```

to run the design, then:
```bash
make ghdl-view
```

# Syntesis, place & route

### GUI installation
To synthesize the design it is mandatory to use Xilinx tools (It's not exactly true, others tools can be used for synthesize like Mentor tools, but at the end, to make the bitstream, Xilinx tools are mandatory), fortunately Xilinx provides his webpack for Linux. [Click here if you didn't install it yet](http://www.armadeus.org/wiki/index.php?title=ISE_WebPack_installation_on_Linux).

To launch the floorplanner, DISPLAY has to be change:
```bash
export DISPLAY=:0
```

After this installation, ISE can be found in the directory $(Xilinx_root_dir)/bin/lin. To avoid retyping export, a little script launch_ise.sh can be made in bin/lin/ directory:
```bash
#!/bin/bash
export DISPLAY=:0
~/Xilinx92i/bin/lin/ise
```

There is a good tutorial on [harded.free.fr](http://harded.free.fr/site/?p=31)

### Using Xilinx command line tools for shell syntesis

See [Using Xilinx Webpack-8.1i on grml Linux in scripted mode, without GUI](http://panteltje.com/panteltje/fpga/index.html) for an introduction.

First of all, library files has to be copied in library directory :
```bash
sudo -s
mkdir /usr/local/lib/xilinx/
cp Xilinx_directory/bin/lin/*.so /usr/local/lib/xilinx/
echo /usr/local/lib/xilinx >> /etc/ld.so.conf
ldconfig
```

Then modify your .bashrc (add at the end):
```bash
PLATFORM=lin
XILINX=Xilinx_directory
export XILINX
PATH=Xilinx_directory/bin/lin:$PATH
export PATH
```

Then ISE can be used in command line (xst, ngdbuild, map, bit,...). To avoid typing very long commands it can be a good idea to use a Makefile, xess.com provide a full [Makefile](http://www.xess.com/appnotes/makefile.php) to do this and a basic Makefile for simulation and synthesis can be found in the armadeus gitlab project: [1](https://gitlab.com/armadeus/armadeus-bsp/-/blob/master/firmware/wishbone_example/wishbone_example9328_27/Makefile). To use it modify the head and write the names of your files :

- General Options
```bash
# project name
PROJECT=bus_led_top
# vhdl files
FILES = src/bus_led.vhd src/bus_led_top.vhd
```

- constraints for synthesis
```bash
# pin configuration
UCF_FILE = src/bus_led.ucf
# Synthesis constraints file
XCF_FILE =
```

- Testbench options
```bash
# testbench
SIMTOP = led_top_tb
SIMFILES = ../apf_pkg/apf_test_pkg.vhd testbench/led_top_tb.vhd
```

- Simulation can stop after a given time or after an assert error (end of test for example)
```bash
# Simu break condition
GHDL_SIM_OPT    = --assert-level=error
#GHDL_SIM_OPT    = --stop-time=500ns
```
